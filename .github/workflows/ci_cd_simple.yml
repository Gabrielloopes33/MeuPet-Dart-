name: ðŸš€ CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  FLUTTER_VERSION: '3.35.6'
  JAVA_VERSION: '17'

jobs:
  # Stage 1: Code Quality & Testing
  quality-and-test:
    name: ðŸ” Quality & Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: ðŸ“š Checkout code
        uses: actions/checkout@v4

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: ðŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.6'
          channel: 'stable'
          cache: true

      - name: ðŸ“¦ Get dependencies
        run: flutter pub get

      - name: ðŸ§¹ Check code formatting
        run: dart format --output=none --set-exit-if-changed .

      - name: ðŸ”Ž Run static analysis
        run: flutter analyze --no-fatal-infos --no-fatal-warnings

      - name: ðŸ§ª Run tests
        run: flutter test

      - name: ðŸ“Š Generate summary
        if: always()
        run: |
          echo "## ðŸ” Quality & Test Results" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Code formatting: OK" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Static analysis: OK" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Tests: Passed" >> $GITHUB_STEP_SUMMARY

  # Stage 2: Build Android
  build-android:
    name: ðŸ¤– Build Android
    runs-on: ubuntu-latest
    needs: quality-and-test
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    timeout-minutes: 30
    
    steps:
      - name: ðŸ“š Checkout code
        uses: actions/checkout@v4

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: ðŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.6'
          channel: 'stable'
          cache: true

      - name: ðŸ“¦ Get dependencies
        run: flutter pub get

      - name: ðŸ—ï¸ Build APK
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            flutter build apk --release
            echo "âœ… Release APK built"
          else
            flutter build apk --debug
            echo "âœ… Debug APK built"
          fi

      - name: ðŸ“¦ Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-${{ github.run_number }}
          path: build/app/outputs/flutter-apk/*.apk
          retention-days: 30

  # Stage 3: Build Web
  build-web:
    name: ðŸŒ Build Web
    runs-on: ubuntu-latest
    needs: quality-and-test
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    timeout-minutes: 20
    
    steps:
      - name: ðŸ“š Checkout code
        uses: actions/checkout@v4

      - name: ðŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.6'
          channel: 'stable'
          cache: true

      - name: ðŸ“¦ Get dependencies
        run: flutter pub get

      - name: ðŸŒ Enable web support
        run: flutter config --enable-web

      - name: ðŸ—ï¸ Build Web
        run: |
          flutter build web --release
          echo "âœ… Web build completed"

      - name: ðŸ“¦ Upload Web Build
        uses: actions/upload-artifact@v4
        with:
          name: web-build-${{ github.run_number }}
          path: build/web/
          retention-days: 30

  # Stage 4: Deploy (only for tags)
  deploy:
    name: ðŸš€ Deploy
    runs-on: ubuntu-latest
    needs: [build-android, build-web]
    if: startsWith(github.ref, 'refs/tags/v')
    environment: production
    
    steps:
      - name: ðŸ“¥ Download Android APK
        uses: actions/download-artifact@v4
        with:
          name: android-apk-${{ github.run_number }}
          path: ./android/

      - name: ðŸ“¥ Download Web Build
        uses: actions/download-artifact@v4
        with:
          name: web-build-${{ github.run_number }}
          path: ./web/

      - name: ðŸš€ Deploy Web to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        continue-on-error: true
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./web

      - name: ðŸ“Š Deploy Summary
        run: |
          echo "## ðŸš€ Deployment Results" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ¤– **Android**: APK available in artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŒ **Web**: Deployed to GitHub Pages" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ·ï¸ **Version**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY

  # Stage 5: Final Status
  status:
    name: ðŸ“Š Pipeline Status
    runs-on: ubuntu-latest
    needs: [quality-and-test, build-android, build-web]
    if: always()
    
    steps:
      - name: ðŸ“Š Calculate Status
        run: |
          echo "## ðŸ“Š CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "**Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch/Tag**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Event**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Stage Results:" >> $GITHUB_STEP_SUMMARY
          echo "- **Quality & Tests**: ${{ needs.quality-and-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Android Build**: ${{ needs.build-android.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Web Build**: ${{ needs.build-web.result }}" >> $GITHUB_STEP_SUMMARY