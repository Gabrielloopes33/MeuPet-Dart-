name: ðŸ” Code Quality & Analysis

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  code-quality:
    name: ðŸ“Š Code Quality Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ðŸ“š Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: ðŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.3'
          channel: 'stable'
          cache: true

      - name: ðŸ” Verify Flutter installation
        run: flutter doctor -v

      - name: ðŸ“¦ Get dependencies
        run: flutter pub get

      - name: ðŸ”’ Check for dependency vulnerabilities
        run: |
          flutter pub deps
          echo "âœ… Dependencies verification completed"

      - name: ðŸ“ Verify pubspec.yaml
        run: |
          if [ ! -f pubspec.yaml ]; then
            echo "âŒ pubspec.yaml not found!"
            exit 1
          fi
          echo "âœ… pubspec.yaml found and valid"

      - name: ðŸ§¹ Check code formatting
        run: |
          dart format --output=none --set-exit-if-changed .
          echo "âœ… Code formatting check completed"

      - name: ðŸ”Ž Run static analysis
        run: |
          flutter analyze --no-fatal-infos
          echo "âœ… Static analysis completed"

      - name: ðŸ—ï¸ Check if project builds
        run: |
          flutter build apk --debug --no-sound-null-safety
          echo "âœ… Debug build completed successfully"

      - name: ðŸ“Š Generate analysis report
        if: always()
        run: |
          echo "## ðŸ“Š Code Quality Report" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Dependencies verified" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Code formatted properly" >> $GITHUB_STEP_SUMMARY  
          echo "- âœ… No static analysis issues" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Project builds successfully" >> $GITHUB_STEP_SUMMARY

  security-scan:
    name: ðŸ” Security Analysis
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
      - name: ðŸ“š Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Run security scan
        uses: securecodewarrior/github-action-add-sarif@v1
        continue-on-error: true
        with:
          sarif-file: 'security-scan.sarif'

      - name: ðŸ” Check for sensitive files
        run: |
          echo "ðŸ” Checking for sensitive files..."
          
          # Check for common sensitive file patterns
          SENSITIVE_FILES=$(find . -type f \( \
            -name "*.key" -o \
            -name "*.pem" -o \
            -name "*.p12" -o \
            -name "*.jks" -o \
            -name "google-services.json" -o \
            -name "GoogleService-Info.plist" \
          \) -not -path "./.git/*" | head -10)
          
          if [ ! -z "$SENSITIVE_FILES" ]; then
            echo "âš ï¸ Potentially sensitive files found:"
            echo "$SENSITIVE_FILES"
            echo "Please ensure these files contain only non-sensitive data or are properly gitignored"
          else
            echo "âœ… No obviously sensitive files found in repository"
          fi

      - name: ðŸ“Š Security summary
        run: |
          echo "## ðŸ” Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Security scan completed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Sensitive files check completed" >> $GITHUB_STEP_SUMMARY
